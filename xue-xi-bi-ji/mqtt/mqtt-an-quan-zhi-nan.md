# MQTT安全指南

* **MQTT 安全解析：构建可靠的物联网系统**
* 认证
  * **用户名/密码认证**：用户名/密码认证方法介绍，如何在 MQTT 中使用，以及该方法可能存在的隐患与解决办法。
  * **SCRAM 增强认证**：增强认证的作用及用法，如何通过增强认证弥补用户名/密码认证方法的不足。
  * **其他认证方法**：Token 认证如 JWT 等。
* **授权**：权限控制与认证的区别，访问控制列表介绍。
* **流量控制**：常见流量控制策略介绍。
* **TLS/SSL**：单向认证、双向认证、TLS PSK、一机一密讲解，TLS 使用注意事项。
* 基础设施安全：如何从基础设施方面加强物联网系统安全性。
* 报文加密：各类加密方式与密钥管理方法介绍。
* MQTT 模糊测试：如何通过模糊测试发现物联网系统中的安全漏洞。

## 如何构建可靠的物联网系统

* **认证和授权机制不充分。** 物联网设备如果认证机制薄弱或没有认证机制，会使其容易受到未经授权的访问。开发者不仅需要控制设备的访问，还要控制设备连接到网络后被允许做什么。
* **薄弱的密码。** 一些厂商可能对同一设备型号使用相同的密码，或者是使用容易被猜到的弱密码，如「admin」或「password」等。 然而即使是最复杂的加密算法，也无法保障一个容易猜到的密码不被攻破。薄弱的密码使攻击者很容易窃取对设备及其数据的访问权限。因此物联网企业应严格执行强密码政策，并要求用户更改默认密码。
* **不安全的通信协议。** 使用 TCP 等明文协议而不是 TLS 进行通信，会使得攻击者很容易截获数据。以中间人攻击（Man-In-The-Middle）为例，攻击者可以窃听通信，收集密码、健康信息等个人数据。
* **缺乏用户培训。** 一些物联网厂商可能没有向其用户提供适当的安全培训，这使未受过教育的用户容易受到攻击。企业应注意提升用户的安全意识。
* **拒绝服务（DoS）攻击。** 物联网系统可能容易受到 DoS 或分布式 DoS 攻击，这种攻击下大量设备会被用来利用软件缺陷或简单地通过恶意流量来压垮或淹没目标系统。为了防止这种攻击，物联网系统需要有强大的安全措施，包括防火墙、入侵检测和预防系统，以及访问控制。此外，物联网系统应被设计成更具弹性、能够自动检测和缓解攻击，减少管理运维的人力成本。

{% hint style="info" %}
在物联网系统设计与建设时优先考虑安全问题，以确保其设备的安全，以及面对攻击时能够弹性应对。
{% endhint %}

## 如何通过 MQTT 保障物联网系统安全？ <a href="#ru-he-tong-guo-mqtt-bao-zhang-wu-lian-wang-xi-tong-an-quan" id="ru-he-tong-guo-mqtt-bao-zhang-wu-lian-wang-xi-tong-an-quan"></a>

当我们使用 MQTT 构建自己的物联网系统时，可以从以下几个方面考虑安全性问题。按其所在的不同协议层进行细分，可以分为网络层、传输层和应用层。

* **网络层。** MQTT 在 IP 网络中运行，因此网络层的安全最佳实践都适用于 MQTT。 也就是说，正确使用防火墙、VPN、IPsec，可以帮助防止入侵者访问物联网网络上的数据。
*   **传输层。** 在传输层，我们并不建议通过 TCP 或 WebSocket 等协议直接发送明文数据，例如在应用层中用于认证的用户名、密码等敏感数据，这可能会使应用层的安全机制形同虚设。因为当入侵者直接从传输层窃取数据时，他可以直接知道你正在使用的用户名和密码。

    更好的办法是，借助 TLS 加密协议为我们的数据提供端到端的安全性。除了使数据变成难以破解的密文数据以外，TLS 还能提供多项保护，例如支持客户端对服务端身份合法性的确认，当要求客户端使用证书时，服务端也能确认客户端是否合法，这将有效避免中间人攻击。
*   **应用层。** 虽然我们已经能够在传输层提供比较到位的安全保护了，但并不是所有的系统都支持 TLS。运行于应用层的 MQTT 协议也通过用户名、密码字段提供了对密码认证和 Token 认证的支持，确保只有合法的设备才能接入 MQTT 代理。MQTT 5.0 中还引入了增强认证机制来提供双向的身份确认。

    另一方面，应用层的安全机制通常也是最后一层安全保障，除了验证接入者的身份，我们最好对接入者能够执行的操作也进行检查，例如接入者可以发布消息到哪些主题上，以及可以从哪些主题消费消息。

## 通过用户名密码认证保障 MQTT 接入安全

### MQTT 中的认证 <a href="#mqtt-zhong-de-ren-zheng" id="mqtt-zhong-de-ren-zheng"></a>

在 MQTT 中，认证是在连接建立时对客户端或者服务端的身份进行验证的过程。它仅涉及是否有权限连接到 Broker，与授权不同，后者决定客户端可以发布和订阅哪些主题。

* **基于密码的认证**：Broker 检查客户端是否具有正确的连接凭据，包括用户名、客户端 ID 和密码。Broker 可以根据密码验证用户名或客户端 ID。
* **增强认证：**引入了支持质询-响应机制的认证框架，可以支持 SCRAM、Kerberos 等多种认证机制。
* 其他：如基于令牌的身份验证（例如 JWT）等。

### 基于密码的认证 <a href="#ji-yu-mi-ma-de-ren-zheng" id="ji-yu-mi-ma-de-ren-zheng"></a>

基于密码的认证是一种通过检验连接方是否拥有正确的密码凭据来确认连接方身份的方法。

在 MQTT 中，基于密码的认证通常使用用户名和密码作为凭据，但在某些特殊场景下，有些客户端可能无法提供用户名，因此客户端 ID 也可以作为唯一标识来代表身份。

当 MQTT 客户端与 Broker 建立连接时，它会在 CONNECT 报文中携带**用户名**和**密码**。下面的示例展示了用 Wireshark 工具抓取的客户端 CONNECT 报文，其中 Client ID 为 client1，用户名为 user，密码为 MySecretPassword。

![客户端 CONNECT 报文](https://assets.emqx.com/images/001d8254b188ba71a364a3d1ac3fbb3f.png?imageMogr2/thumbnail/1520x)

Broker 从 CONNECT 报文中提取用户名（或客户端 ID）和密码后，需要在相应的数据库中查询该用户名对应的凭据，然后与客户端发送的密码进行比较。如果数据库中不存在该用户名，或者密码与数据库中的凭据不一致，Broker 将拒绝客户端的连接请求。

基于密码的认证可以确保只有拥有正确凭据（即用户名和密码）的客户端才能连接到 Broker。但是，正如在 Wireshark 抓包过程中所见，如果有人能够黑进通信通道，他们就可以轻松地截取数据包并获取连接凭据，因为它们都以明文形式发送。

### 使用 Salt 和 Hash 保护你的密码 <a href="#shi-yong-salt-he-hash-bao-hu-ni-de-mi-ma" id="shi-yong-salt-he-hash-bao-hu-ni-de-mi-ma"></a>

以明文方式存储密码是一种危险的做法，因为这将导致密码容易被窃取。如果攻击者获得了密码数据库或密码文件的访问权，他们就可以轻松地读取并使用密码对系统进行非法访问。为了防止这种情况发生，密码应该在存储之前经过哈希和 Salt 加密。

哈希是一个函数，接收输入数据，对数据进行数学运算，然后生成一个与原始输入数据完全无关的哈希值。这样做的目的是为了混淆原始输入数据。这个函数应该是不可逆的，确保不能根据输出还原输入。然而，哈希值本身并不安全，可能会受到字典攻击，如下例所示。

sha256 hash: 8f0e2f76e22b43e2855189877e7dc1e1e7d98c226c95db247cd1d547928334a9

加密后的密码看起来很安全，通过观察你无法推测出密码是什么。然而，对于一个固定的密码，哈希值总是相同的。因此，很容易制作一个包含常用密码及其哈希值的数据库。如下表：

| **sha256 hash**                                                  | **明文密码**   |
| ---------------------------------------------------------------- | ---------- |
| dc1e7c03e162397b355b6f1c895dfdf3790d98c10b920c55e91272b8eecada2a | MyPassword |
| 8f0e2f76e22b43e2855189877e7dc1e1e7d98c226c95db247cd1d547928334a9 | passw0rd   |
| 27cc6994fc1c01ce6659c6bddca9b69c4c6a9418065e612c69d110b3f7b11f8a | hello123   |

黑客就可以从在线哈希数据库中搜索这个哈希值，从而得到密码 **passw0rd**。

在密码中加入 Salt 可以解决这个问题。Salt 是一串随机的字符，在哈希运算之前被附加到密码中。这使得即使密码相同，加入 Salt 后它们的哈希值也会不一样。Salt 与密码的哈希值一起存储在数据库中，当用户登录时，将 Salt 拼接到他们的密码中，然后将生成的哈希值与存储在数据库中的哈希值进行比较。如果哈希值相同，用户就被允许访问。

在执行哈希函数之前，在密码中插入一串随机的字符串，这个随机字符串就是 Salt。

例如，Salt 为 **az34ty1**，sha256(passw0rd**az34ty1**) 为 ：6be5b74fa9a7bd0c496867919f3bb93406e21b0f7e1dab64c038769ef578419d

这个哈希值很难在哈希数据库中匹配，因为要想匹配该值，哈希数据库需要为密码 **passw0rd** 添加海量的条目。

### 基于密码的认证方法在 MQTT 中的最佳实践 <a href="#ji-yu-mi-ma-de-ren-zheng-fang-fa-zai-mqtt-zhong-de-zui-jia-shi-jian" id="ji-yu-mi-ma-de-ren-zheng-fang-fa-zai-mqtt-zhong-de-zui-jia-shi-jian"></a>

* 在 MQTT 中进行基于密码的认证，最重要的一点是要选择复杂和独特的密码。容易被破解或在多个账户中重复使用的密码会危害整个 MQTT 系统的安全。
* 安全地存储和传输密码以防止它们被恶意窃取也非常重要。例如，密码应在存储前进行 Hash 和 Salt 加密，并通过 TLS 等安全通道进行传输。
* 此外，为了减少密码的暴露，不要在代码或配置文件中硬编码密码，而是应该使用环境变量或其他安全存储机制。

## 使用 SSL/TLS 加强 MQTT 通信安全

### 概念解释 <a href="#gai-nian-jie-shi" id="gai-nian-jie-shi"></a>

在开始之前，让我们先来了解几个关键概念。

* 握手：TLS 握手是客户端和服务器之间建立安全连接的一个过程。在这个过程中，客户端和服务器互相交换信息，以确定安全连接的参数，比如加密算法、会话密钥和认证方法。
* 密码套件：密码套件是一种安全方案，结合了加密、散列和密钥交换算法，用来保障连接的安全。TLS 支持多种密码套件，客户端和服务器可以在握手过程中协商选择密码套件。
* 证书：证书是用来证明服务器或客户端身份的数字文件。证书包含了服务器或客户端的公钥，并且由可信的证书颁发机构（CA）签发。
* 会话：会话是指客户端和服务器之间的一次通信。在会话期间，客户端和服务器通过安全连接交换数据。会话可以由客户端或服务器终止。

### TLS 概述 <a href="#tls-gai-shu" id="tls-gai-shu"></a>

TLS 是一种加密协议，旨在为互联网提供安全的通信。TLS 可以保护密码、信用卡信息和个人信息等敏感数据，不让它们被未授权的人访问或截取。TLS 被广泛应用于网络应用、电子邮件、即时通讯等需要在互联网上进行安全通信的应用场景。

TLS 通过加密、保证数据完整性和认证来提供安全性。

* 加密：TLS 使用加密算法对客户端和服务器之间传输的数据进行加密，以确保未经授权的用户无法读取其内容。
* 数据完整性：TLS 使用数据完整性检查机制，如哈希算法，以确保数据在传输过程中没有被篡改或损坏。
* 认证：TLS 通过使用证书和公钥基础设施，确保客户端与预期的服务器进行通信，避免与冒名顶替者进行通信。

TLS 利用公钥加密法和对称密钥加密法的组合来实现这些安全特性。

客户端和服务器在建立安全连接之前需要进行握手。握手时，客户端和服务器互相发送信息，确定加密算法、会话密钥和认证方法等安全连接参数。TLS 可以使用多种密码套件，客户端和服务器在握手时协商选择密码套件。证书是一个用于证明服务器或客户端身份的数字文件。证书含有服务器或客户端的公钥，并由可信的 CA 签发。通过公钥基础设施（PKI）在客户端和服务器之间建立信任关系。

### 为什么 TLS 对 MQTT 安全至关重要？ <a href="#wei-shen-me-tls-dui-mqtt-an-quan-zhi-guan-zhong-yao" id="wei-shen-me-tls-dui-mqtt-an-quan-zhi-guan-zhong-yao"></a>

对于 MQTT 安全来说，TLS 有着重要作用。它可以保证 MQTT 消息的机密性、完整性、不可否认性。它可以防止敏感数据被未授权的用户获取、篡改和拦截，并在 MQTT 客户端和 Broker 之间建立一个安全和可信的通信通道。

TLS 通过对 MQTT 客户端和 Broker 之间的数据进行加密来保护机密性。如果没有 TLS，MQTT 消息就会以明文形式发送，这意味着任何有网络访问权限的人都可以截取和读取数据。使用 TLS 可以使消息内容加密，未授权无法访问。

TLS 提供数据完整性保护。它可以防止 MQTT 消息在传输过程中被篡改或破坏。每条消息都通过 TLS 进行数字签名，确保它在传输过程中没有未经授权的修改。如果发生任何未经授权的更改，完整性检查将失败，表明数据已经被篡改。

TLS 实现了认证功能，以确保 MQTT 客户端和 Broker 之间可以相互验证身份。客户端可以利用 SSL/TLS 证书，检查他们是否与合法授权的 Broker 建立了连接。这样可以避免恶意实体假冒 Broker，并在客户端和 MQTT 基础设施之间建立信任关系。

TLS 提供了不可否认的特性。通过使用数字签名，TLS 防止发件人否认其消息传输。数字签名确认了消息的真实性和来源，因此可以证明特定客户端发送了特定的消息。

最后，TLS 还能保护 MQTT 通信免受窃听攻击，即攻击者截取并监听 MQTT 消息。它也能防止中间人攻击，即攻击者试图拦截和篡改客户端和 Broker 之间传递的消息。

### TLS 认证方法 <a href="#tls-ren-zheng-fang-fa" id="tls-ren-zheng-fang-fa"></a>

#### 单向认证 <a href="#dan-xiang-ren-zheng" id="dan-xiang-ren-zheng"></a>

单向认证是 TLS 中最简单的认证方式。在单向认证中，服务器向客户端出示数字证书，客户端检查该证书，以确认它是有效的，并且是由可信的 CA 签发的。如果证书通过验证，客户端就可以与服务器建立安全连接。当不需要认证客户端时，单向认证就可以满足需求。

#### 双向认证 <a href="#shuang-xiang-ren-zheng" id="shuang-xiang-ren-zheng"></a>

双向认证，或称为 mTLS，是 TLS 中更安全的认证方式。在双向认证中，客户端和服务器会互相认证。客户端向服务器出示数字证书，服务器检查该证书，确认它是有效的，并且是由可信的 CA 签发的。服务器也向客户端出示数字证书，客户端检查该证书，确认它是有效的，并且是由可信的 CA 签发的。如果两个证书都通过验证，客户端和服务器就可以建立安全连接。当需要同时验证客户端和服务器的身份时，就会采用双向认证。

#### PSK 认证 <a href="#psk-ren-zheng" id="psk-ren-zheng"></a>

预共享密钥（PSK）是一种利用共享密钥来认证客户端和服务器的方法。客户端和服务器在连接之前先商定一个密钥。在握手过程中，客户端和服务器使用这个密钥来确认对方。当无法使用公钥加密法时，就可以采用 PSK。这种方法没有其他方法安全，因为每次连接都使用同一个密钥。

#### 无证书加密 <a href="#wu-zheng-shu-jia-mi" id="wu-zheng-shu-jia-mi"></a>

无证书加密技术利用密钥协议，例如 Diffie-Hellman，让客户端和服务器生成一个共享密钥。这样，它们就可以在彼此之间建立安全的通信通道。这种共享密钥不会通过网络传输，因此难以被拦截或窃听。与此同时，无证书加密技术还消除了依赖可信第三方颁发和管理数字证书的需求，简化了 TLS 的实施和管理。然而，这种方法的主要限制在于要求客户端和服务器都具备相同的密钥协议参数，这在某些情况下可能带来挑战。此外，由于无证书加密技术在 TLS 实现中的普及度有限，其在实践中的适用性可能受到一定限制。

### 选择合适的认证方法 <a href="#xuan-ze-he-kuo-de-ren-zheng-fang-fa" id="xuan-ze-he-kuo-de-ren-zheng-fang-fa"></a>

认证方法的选择对于保障 TLS 的安全性非常重要。选择认证方法时，要考虑安全性的要求、实施的复杂性和资源的限制。

* 单向认证适用于客户端的身份不重要的情况。
* 双向认证需要客户端和服务器都进行身份验证。
* 当无法使用公钥加密算法时，PSK 是一种替代选择，但其安全性低于公钥加密算法。
* 当数字证书无法获取或无法被信任时，无证书加密技术是一种有效的解决方案。
* 当网络中的设备具有不同的安全需求，或整个网络的安全性取决于每个设备的安全性时，每个设备使用专用密钥特别有用。

在选择认证方法时，应该进行全面的需求和风险分析，以便做出明智的决策。

### 最佳实践 <a href="#zui-jia-shi-jian" id="zui-jia-shi-jian"></a>

在实施 TLS 时，需要进行谨慎的规划和执行，以确保通信的安全性。以下是一些实施 TLS 的最佳实践：

* 使用最新版本的 TLS：选择最新版本的 TLS 协议，以使用最安全的加密和哈希算法。
* 使用强壮的密码套件：选择强壮的密码套件，确保提供高强度的加密和数据完整性。
* 使用可信的证书： 使用由可信的 CA 签发的数字证书来验证服务器或客户端的身份。
* 实施证书撤销：建立证书撤销机制，用于撤销已被破坏或过期的证书。
* 监控证书到期：监控数字证书的到期情况，确保及时进行更新。
* 安全密钥管理：创建安全的密钥管理系统，来管理用于认证的密钥。
* 定期更新和修补软件：定期更新和修补用于 TLS 实施的软件，以解决任何已知漏洞。
